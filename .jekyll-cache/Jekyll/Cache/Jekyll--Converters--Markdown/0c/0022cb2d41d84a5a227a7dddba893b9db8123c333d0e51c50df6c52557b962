I"€<p>#å‰è¨€</p>

<p>reduxå’Œkoaéƒ½é€šè¿‡å„è‡ªçš„æ–¹å¼å®ç°äº†æ´‹è‘±æ¨¡å‹ï¼Œæ¯ä¸€ä¸ªä¸­é—´ä»¶å±‚å±‚ä¼ é€’ç›´åˆ°æœ€åçš„ä¸­é—´å±‚ç„¶ååˆä¼šå±‚å±‚è¿”å›ç›´åˆ°ç¬¬ä¸€ä¸ªä¸­é—´ä»¶ã€‚é‚£ä¹ˆä»–ä»¬æ˜¯è¿™ä¹ˆå®ç°çš„å‘¢</p>

<h2 id="reduxä¸­é—´ä»¶">reduxä¸­é—´ä»¶</h2>

<p>reduxçš„ä¸­é—´ä»¶åœ¨reduxæºç ä¸­æœ‰æåˆ°è¿‡ä¸€äº›ï¼Œæ‰€ä»¥å…ˆçœ‹ä¸­é—´ä»¶æ˜¯æ€ä¹ˆå†™ï¼Œreduxçš„ä¸­é—´ä»¶éƒ½æ˜¯ä¸€ä¸ªä¸‰å±‚åŒ…è£¹çš„å‡½æ•°ç¬¬ä¸€å±‚æ˜¯æ¥æ”¶reduxçŠ¶æ€ç”¨çš„ï¼Œå‚æ•°æ˜¯ä¸€ä¸ªåŒ…å«getStateå’Œdispatchçš„å¯¹è±¡ï¼Œç¬¬äºŒå±‚æ¥æ”¶ä¸€ä¸ªnextå‡½æ•°ï¼Œåœ¨è¿è¡Œæ—¶å®é™…å°±æ˜¯ä¸‹ä¸€ä¸ªè¦æ‰§è¡Œçš„ä¸­é—´ï¼Œæœ€åä¸€å±‚æ˜¯ä¸€ä¸ªæ¥æ”¶å’Œæ‰§è¡Œactionçš„æ–¹æ³•ã€‚</p>

<pre><code class="language-javascript">//_ref2 = {
//		getState,
//		dispatch
//}
function sagaMiddleware(_ref2) {
  var getState = _ref2.getState,
      dispatch = _ref2.dispatch;

  var sagaEmitter = emitter();
  sagaEmitter.emit = (options.emitter || ident)(sagaEmitter.emit);

  sagaMiddleware.run = runSaga.bind(null, {
    context: context,
    subscribe: sagaEmitter.subscribe,
    dispatch: dispatch,
    getState: getState,
    sagaMonitor: sagaMonitor,
    logger: logger,
    onError: onError
  });

  return function (next) {
    return function (action) {
      if (sagaMonitor &amp;&amp; sagaMonitor.actionDispatched) {
        sagaMonitor.actionDispatched(action);
      }
      var result = next(action); // hit reducers
      sagaEmitter.emit(action);
      return result;
    };
  };
}

</code></pre>

<pre><code class="language-js">//reduxä¸­é—´ä»¶éª¨æ¶
{getState,dispatch} =&gt;next =&gt; action=&gt;{

}
</code></pre>

<p>ä¸‹é¢æ˜¯reduxå®ç°ä¸­é—´ä»¶æ´‹è‘±æ¨¡å‹çš„æ ¸å¿ƒ</p>

<pre><code class="language-js">  var chain = []
		//ä½œä¸ºæ‰€æœ‰ä¸­é—´ä»¶çš„ä¸Šå±‚å‚æ•°
    var middlewareAPI = {
      getState: store.getState,
      dispatch: (action) =&gt; dispatch(action)
    }
    //æ‰§è¡Œä¸­é—´ä»¶çš„ç¬¬ä¸€å±‚æ–¹æ³•ï¼Œå¾—åˆ°ä¸­é—´ä»¶çš„ç¬¬äºŒå±‚å‡½æ•°å¹¶æŠŠmiddlewareAPIä½œä¸ºå‚æ•°é€šè¿‡é—­åŒ…ç»‘å®šåˆ°ä¸­é—´ä»¶å†…éƒ¨
    chain = middlewares.map(middleware =&gt; middleware(middlewareAPI))

    //è¢«æ‰€æœ‰ä¸­é—´ä»¶åŒ…è£…è¿‡åç”Ÿæˆçš„æ–°çš„dispatchæ–¹æ³•
    dispatch = compose(...chain)(store.dispatch)

//compose.js
//composeæ–¹æ³•æ˜¯ä¸€ä¸ªé«˜é˜¶å‡½æ•°æ¥æ”¶ä¸€ä¸ªå‡½æ•°æ•°ç»„ï¼Œç”¨reduceæ–¹æ³•æŠŠæ‰€æœ‰æ–¹æ³•æ‰§è¡Œä¸€éï¼ˆä¹Ÿå°±æ˜¯ä¸­é—´ä»¶ç¬¬äºŒå±‚ï¼‰ï¼Œæ¯ä¸€ä¸ª
//ä¸­é—´ä»¶éƒ½æ¥æ”¶ä¸Šä¸€ä¸ªä¸­é—´ä»¶å‡½æ•°çš„ç»“æœä½œä¸ºå‚æ•°ï¼ˆä¹Ÿå°±æ˜¯ç¬¬ä¸‰å±‚ï¼‰ï¼Œæœ€ç»ˆæœ€åº•å±‚æ‰§è¡Œçš„æ˜¯dispatchæ–¹æ³•ï¼Œé€šè¿‡è¿™ç§æ–¹å¼
//æ‰€æœ‰çš„ä¸­é—´ä»¶éƒ½å¯ä»¥é€šè¿‡åœ¨å†…éƒ¨æ‰§è¡Œnextæ–¹æ³•å¯åŠ¨ä¸‹ä¸€ä¸ªä¸­é—´ä»¶çš„æ‰§è¡Œï¼Œä»è€Œå®ç°äº†åœ¨nextä¹‹å‰å°±æ˜¯è¿˜æœªæ‰§è¡Œactionï¼Œ
//nextä¹‹åå°±æ˜¯actionæ‰§è¡Œä¹‹å
export default function compose(...funcs) {
  if (funcs.length === 0) {
    return arg =&gt; arg
  }

  if (funcs.length === 1) {
    return funcs[0]
  }

  const last = funcs[funcs.length - 1]
  const rest = funcs.slice(0, -1)
  return (...args) =&gt; rest.reduceRight((composed, f) =&gt; f(composed), last(...args))
}

</code></pre>

<h2 id="koaä¸­é—´ä»¶">KOAä¸­é—´ä»¶</h2>

<p>koaä¸­é—´ä»¶çš„å®ç°æ–¹å¼ä¸reduxä¸åŒæ˜¯é€šè¿‡Promiseæ¥æ§åˆ¶ä¸­é—´ä»¶çš„æ‰§è¡Œæ­¥éª¤ï¼Œåœ¨ä¸­é—´ä»¶å†…éƒ¨åˆæœ‰awaitå‡½æ•°æ¥ä¿è¯ä¸­é—´ä»¶æ‰§è¡Œå®Œæ¯•æ‰èƒ½ç»§ç»­å®è¡Œã€‚</p>

<p>koaä¸­é—´ä»¶ä¸reduxä¸åŒï¼Œæ¯ä¸€ä¸ªä¸­é—´ä»¶å…¶å®éƒ½æ˜¯ä¸€ä¸ªasync å‡½æ•°ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡awaitæ¥ä¿è¯ä¸­é—´ä»¶çš„åŒæ­¥æ‰§è¡Œé¡ºåº</p>

<pre><code class="language-js">function log( ctx ) {
    console.log( ctx.method, ctx.header.host + ctx.url )
}


async function ( ctx, next ) {
    log(ctx);
    await next()
}

</code></pre>

<pre><code class="language-js">function compose (middleware) {
  if (!Array.isArray(middleware)) throw new TypeError('Middleware stack must be an array!')
  for (const fn of middleware) {
    if (typeof fn !== 'function') throw new TypeError('Middleware must be composed of functions!')
  }

  /**
   * @param {Object} context
   * @return {Promise}
   * @api public
   */
//ä¸­é—´ä»¶æ•°ç»„é¡ºåºè°ƒç”¨ï¼Œä½†æ˜¯æ¯ä¸€ä¸ªä¸‹ä¸€ä¸ªä¸­é—´ä»¶çš„æ‰§è¡Œéƒ½æ˜¯ç”±ä¸Šä¸€ä¸ªä¸­é—´ä»¶çš„await next()å‘¼èµ·ï¼Œä¿è¯
//åœ¨ä¸­é—´ä»¶çš„æ‰§è¡Œè¿‡ç¨‹ä¸­æ‰€æœ‰çš„nextæ‰§è¡Œå®Œæ‰èƒ½ç»§ç»­æ‰§è¡Œ
  
  //åŸºæœ¬æµç¨‹
  await next=&gt;{
    //ä¸­é—´ä»¶A
    //do something
    await next=&gt;{
       //ä¸­é—´ä»¶B
       //do something
      await next=&gt;{
       //ä¸­é—´ä»¶C
            //do something
      			//ç›´åˆ°ä¸­é—´ä»¶å…¨éƒ¨æ‰§è¡Œå®Œæ¯•ï¼Œæ‰§è¡ŒPromise.resolve()
            //do something
   	 	}
        //do something
    }
        //do something
  }
  
  return function (context, next) {
    // last called middleware #
    let index = -1
    return dispatch(0)
    function dispatch (i) {
      if (i &lt;= index) return Promise.reject(new Error('next() called multiple times'))
      index = i
      let fn = middleware[i]
      if (i === middleware.length) fn = next
      if (!fn) return Promise.resolve()
      try {
        return Promise.resolve(fn(context, function next () {
          return dispatch(i + 1)
        }))
      } catch (err) {
        return Promise.reject(err)
      }
    }
  }
}
</code></pre>

<h2 id="æ€»ç»“">æ€»ç»“</h2>

<p>â€‹		ä¸¤ç§ä¸­é—´ä»¶å®ç°çš„æ–¹å¼è™½ç„¶æœ‰æ‰€ä¸ä¸€æ ·ï¼Œä½†æ˜¯éƒ½å®ç°äº†æ´‹è‘±æ¨¡å‹çš„æ•ˆæœï¼Œå°†ä¸­é—´ä»¶çš„æ‰§è¡Œåšäº†å±‚å±‚åŒ…è£¹ï¼Œä¸€ç§å¯¹ä¸­é—´ä»¶çš„ä»£ç æ ¼å¼æå‡ºäº†ç®€åŒ–äº†æœ¬èº«çš„æ§åˆ¶ï¼Œä¸€ç§æ˜¯åŠ å¼ºäº†å†…éƒ¨çš„æµç¨‹æ§åˆ¶å¯¹å¤–éƒ¨ä¼ å…¥çš„ä¸­é—´ä»¶è¦æ±‚æ¯”è¾ƒå°‘ã€‚ä½†æ˜¯ä»–ä»¬çš„ä»£ç æ–¹å¼éƒ½æ˜¯å€¼å¾—å­¦ä¹ çš„ã€‚</p>
:ET