---
title: Redux源码分析
description: 对Redux功能核心实现做一些解读
categories:
 - Javascript
tags: 
 - 源码
---


##createStore方法

createStore 创建 store
    subscribe redux插件通过该方法监听state变化， 例如saga监听对应的action操作
    
```js

export default function createStore(reducer, preloadedState, enhancer) {
  if (typeof preloadedState === 'function' && typeof enhancer === 'undefined') {
    enhancer = preloadedState
    preloadedState = undefined
  }

  if (typeof enhancer !== 'undefined') {
    if (typeof enhancer !== 'function') {
      throw new Error('Expected the enhancer to be a function.')
    }
    //存在applyMiddleware 操作时，进一步调用applyMiddlewar将createStore与Middleware结合在一起
    return enhancer(createStore)(reducer, preloadedState)
  }
  //...
}

    // 观察者模式会发送消息通知所有订阅的插件
    //将所有的订阅事件保存
      function subscribe(listener) {
        if (typeof listener !== 'function') {
          throw new Error('Expected listener to be a function.')
        }
    
        var isSubscribed = true
    
        ensureCanMutateNextListeners()
        nextListeners.push(listener)
    
        return function unsubscribe() {
          if (!isSubscribed) {
            return
          }
    
          isSubscribed = false
    
          ensureCanMutateNextListeners()
          var index = nextListeners.indexOf(listener)
          nextListeners.splice(index, 1)
        }
      }
    
    
function dispatch(action) {
    if (!isPlainObject(action)) {
      throw new Error(
        'Actions must be plain objects. ' +
        'Use custom middleware for async actions.'
      )
    }

    if (typeof action.type === 'undefined') {
      throw new Error(
        'Actions may not have an undefined "type" property. ' +
        'Have you misspelled a constant?'
      )
    }

    if (isDispatching) {
      throw new Error('Reducers may not dispatch actions.')
    }

    try {
      isDispatching = true
      //遍历所有的Reducer
      currentState = currentReducer(currentState, action)
    } finally {
      isDispatching = false
    }
    //subscribe方法订阅的事件都会被执行
    var listeners = currentListeners = nextListeners
    for (var i = 0; i < listeners.length; i++) {
      listeners[i]()
    }

    return action
  }

```
    
##applyMiddleware
    applyMiddleware 把中间件与store绑定 ，将中间件的方法绑定到Redux的dispatch上
    在调用的时候就会触发中间件
   
```js
//核心方法，dispat方法会让action流过所有绑定的reducer，以及applyMiddleware添加的中间件
export default function applyMiddleware(...middlewares) {
  return (createStore) => (reducer, preloadedState, enhancer) => {
    var store = createStore(reducer, preloadedState, enhancer)
    var dispatch = store.dispatch
    var chain = []

    var middlewareAPI = {
      getState: store.getState,
      dispatch: (action) => dispatch(action)
    }
    chain = middlewares.map(middleware => middleware(middlewareAPI))
    dispatch = compose(...chain)(store.dispatch)

    return {
      ...store,
      dispatch
    }
  }
}

```